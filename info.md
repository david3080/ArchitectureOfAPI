# はじめに
ここではAPIの基礎とアーキテクチャ探訪への道の一部を発見できればと思います。まずAPIの簡単な定義とインプロセスAPIとアウトオブプロセスAPIについて説明します。そして、APIの重要性を示すために本書を通じてアーキテクチャを進化させていくケーススタディとしてカンファレンスシステムを紹介します。アウトオブプロセスAPIは単純な3層のアーキテクチャを超えた考え方を可能にします。これを示すためにトラフィックパターンとその重要性を紹介します。段階的にケーススタディの概要を説明しますので興味のあるエリアがあればすぐに読み進めることができるようになっています。

APIとそれに関連するエコシステムを表すため、[C4 モデル図](https://www.infoq.com/jp/articles/C4-architecture-model/)を使ってケーススタディを紹介し、アプローチの背後にある仕様と論理を検討します。また、アーキテクチャ決定記録（ADR）の使用とソフトウェアライフサイクル全体にわたる決定を明確に定義することの価値について学びます。最後に「場合による」判断が必要な場合に意思決定を行うのに役立つアプローチであるADRガイドラインについて説明します。

## アーキテクチャ探訪
長旅をしたことのある人なら何度も「まだ着かないの?」と思ったことがあるでしょう。最初の数回はGPSや経路探索を見て、道中で遅延がないことを祈りながら、どのくらいで到着するかを調べます。同じくAPIベースのアーキテクチャを構築するための旅は開発者やアーキテクトにとって複雑なものになり得ます。アーキテクチャ用のGPSがあったとしても目的地はどこだろうと悩むことでしょう。

アーキテクチャは目的地のない旅であり、技術やアーキテクチャのアプローチがどのように変化していくかを予測することはできません。例えば、サービスメッシュ技術がこれほど広く使われるようになるとは予想できなかったかもしれませんが、その機能を知れば既存のアーキテクチャを進化させることを考えるきっかけになるかもしれません。アーキテクチャの変化に影響を与えるのは技術だけではありません。新しいビジネス要件や制約もアーキテクチャの方向性を変える原動力となります。

このように積み上げ式に価値を提供することと新たに登場した技術を組み合わせることで、進化型アーキテクチャのコンセプトが生まれます。進化型アーキテクチャとは、アーキテクチャを積み上げ式で進化させるアプローチであり、スピード感をもって変化させ悪影響を及ぼすリスクを低減させることに重点を置きます。その過程で、APIアーキテクチャにアプローチする際の以下のアドバイスを心に留めておいてください。

>アーキテクトは戦略的な将来計画を立てたいものですが、ソフトウェア開発のエコシステムが常に変化しているため、それは困難なことです。変化を避けることはできないので、変化を利用する必要があるのです。
>[進化的アーキテクチャ](https://www.oreilly.co.jp/books/9784873118567/)より

多くのプロジェクトにおいて、APIそのものは進化的であり、より多くのシステムやサービスが統合されるにつれて変化を求められます。ほとんどの開発者は、利用者の視点からより広範なAPIの再利用を考慮することなく、単一の機能に焦点を当てたサービスを構築してきました。

APIファースト設計は、開発者やアーキテクトがサービスの機能を考慮し、利用者中心にAPIをデザインするアプローチをとります。API利用者はモバイルアプリや他のサービス、あるいは外部の顧客である可能性もあります。第1章では、APIファーストのアプローチをサポートする設計テクニックをレビューし、変化に強く幅広い利用者層に価値を提供するAPIを構築する方法を見つけます。

よい話としては、API駆動型アーキテクチャの旅はどの時点からでも始められるということです。もしあなたが既存の技術の棚卸しを担当しているなら、私たちはあなたのプラットフォームでAPIの利用を促進するためにアーキテクチャを進化させるテクニックをお見せします。一方、もしあなたが幸運にも何もないキャンバスをお持ちなら、私たちの長年の経験に基づいてAPIアーキテクチャを採用する利点を共有し意思決定における重要な要因も強調して紹介します。 

## APIの簡単な紹介
ソフトウェアアーキテクチャの分野では、定義するのが非常に難しい用語がいくつかあります。アプリケーションプログラミングインターフェイスの略であるAPIという用語もこの種類のもので、その概念は80年も前にあらわれたものです。長い間使われてきた用語は、結局使い古され、異なる問題領域で複数の意味を持つようになります。我々はAPIを以下のように考えています。

- APIは基礎となる実装を抽象化したものである。
- APIは型を導入した仕様で表現される。
- 開発者は仕様を理解しツールを使って複数の言語でコードを生成しAPI利用者（APIを消費するソフトウェア）を実装することができる。
- APIは情報交換を効果的にモデル化するためにセマンティクスや動作を定義している。
- 効果的なAPI設計により、顧客や第三者への拡張を可能にし、ビジネス統合を実現する。

大まかに言って、APIはAPIの呼び出しがプロセス内かプロセス外かによって、2つの一般的なカテゴリに分けることができます。ここでいうプロセスとは、オペレーティング・システム（OS）のプロセスのことです。たとえば、あるクラスから別のクラスへのJavaメソッドの呼び出しは、呼び出しが行われたのと同じプロセスで処理されるため、プロセス内(インプロセス)APIの呼び出しとなります。HTTPライブラリを使用して外部のREST的なAPIを呼び出す.NETアプリケーションは、呼び出し元のプロセス以外の追加の外部プロセスによって処理されるため、プロセス外(アウトオブプロセス)API呼び出しとなります。このアウトオブプロセスAPI呼び出しでは、ローカルネットワーク、仮想プライベートクラウド（VPC）ネットワーク、またはインターネットなどのネットワーク上でデータの行き来を伴う可能性があります。我々は後者のアウトオブプロセスAPIのAPIスタイルに焦点を当てます。しかし、アーキテクトはしばしばインプロセスAPIをアウトオブプロセスAPIに移行する必要性に遭遇します。これらを示すために、本書を通じて発展するケーススタディを作成します。

## ケーススタディ: カンファレンスシステム
本書ではカンファレンスシステムをモデル化することをケーススタディとして選びました。というのも、このドメイン(業務領域)は容易に理解することができますが、進化的なアーキテクチャをモデル化するには十分な複雑さを備えているからです。下図では、カンファレンスシステムをトップレベルで可視化し、アーキテクチャのコンテキストを議論の土台に置きます。このシステムでは、外部の利用者がアカウントを作成し、カンファレンスで開催されるセッションを確認し、出席を予約することができます。

![カンファレンスシステムのコンテキストダイアグラム1](./img/1.png)

このカンファレンスシステムのボックスを拡大してみましょう。

![カンファレンスシステムのコンテキストダイアグラム2](./img/2.png)

カンファレンスシステムを拡大するとその主要な技術的構成要素についてより詳細な情報を得ることができます。利用者はWebアプリと対話し、WebアプリはカンファレンスAPIを呼び出します。カンファレンスAPIはSQLを使用してバックエンドのデータベースに問い合わせを行います。

APIの観点からもっとも興味深い機能がカンファレンスAPIのコンテナ内にあります。下図では、この特定のコンテナにズームインし、構造と相互作用を見ることができます。

![カンファレンスシステムのコンテキストダイアグラム3](./img/3.png)

現在のシステムには、4つの主要コンポーネントとデータベースがあります。APIコントローラはUIから入ってくるすべてのトラフィックに対面し、システム内のどこにリクエストをルーティングするかを決定します。また、このコンポーネントはネットワークレベルの表現からオブジェクトやコード上の表現への変換を担当します。APIコントローラ・コンポーネントは、プロセス内ルーティングの観点で接合ポイントとして機能し、いわゆる[フロントコントローラパターン](https://www.samuraiz.co.jp/adobeproduct/jrun/docs/jr4/docs/html/Programmers_Guide/designpatterns4.html)の形式をとることが注目すべきところです。APIリクエストと処理にとってこれは重要なパターンです。すべてのリクエストはコントローラを通過し、コントローラはリクエストがどこに向けられるかを決定します。[第3章](./3.md)ではコントローラをプロセスの外に持ち出す可能性について見ていきます。

出席者、予約、セッションの各コンポーネントは、リクエストをクエリに変換し、プロセス外でデータベースに対してSQLを実行することに関与しています。既存のアーキテクチャでは、データベースは重要なコンポーネントであり、例えば予約とセッション間の制約など、コンポーネント間のリレーションが強制される可能性があります。

さて、適切なレベルまでドリルダウンしたところで、この時点でケーススタディにおけるAPIインタラクションの種類を再確認しておきましょう。

## カンファレンスシステムのケーススタディにおけるAPIの種類
上図におけるWebアプリからAPIコントローラへの矢印はアウトオブプロセスAPI呼び出しであり、APIコントローラから出席者コンポーネントへの矢印はインプロセスAPI呼び出しの例になります。カンファレンスAPI境界内のすべての相互作用はインプロセスAPI呼び出しの例になります。インプロセスAPI呼び出しは、カンファレンスAPIを実装するために使用されるプログラミング言語によって明確に定義され、制限されます。この呼び出しはコンパイル時安全であり、この交換メカニズムはコードを書く時に条件が強制的に決定されます。

## 会議システム変更の理由
現在のアーキテクチャのもと長年にわたってカンファレンスシステムは機能してきましたが、カンファレンスオーナーから下記の3つの改善要求があったため、アーキテクチャの変更を進めています。

- カンファレンス主催者は、モバイルアプリケーションを作りたいと考えています。
- カンファレンス主催者は、年に1回ではなく、数十回のカンファレンスを開催し、システムをグローバルに展開することを計画しています。この拡張を容易にするために講演者とその講演申込を管理する外部のCall for Papers(CFP)システムと統合したいとのことです。
- カンファレンス主催者は、プライベートなデータセンターを廃止し、代わりにグローバルに展開するクラウドプラットフォームでカンファレンスシステムを稼働させたいと考えています。

目標は、既存の本番システムに影響を与えず、すべてを一度に書き換えるのではなく、新しい要件に対応できるカンファレンスシステムに移行することです。

## 階層型アーキテクチャからAPIのモデリングへ
ケーススタディの出発点は、UI、サーバーサイドの処理層、データストアからなる典型的な3層アーキテクチャです。進化型アーキテクチャの議論を始めるには、APIリクエストがコンポーネントによって処理される方法について考えるためのモデルが必要です。パブリッククラウド、データセンターの仮想マシン、ハイブリッドなアプローチのいずれにも対応できるモデル／抽象化が必要になります。

トラフィックを抽象化することで、APIコンシューマとAPIサービス（APIプロデューサと呼ばれることもある）の間のアウトオブプロセス・インタラクションを考えることができるようになります。サービス指向アーキテクチャ(SOA)やマイクロサービス・ベースのアーキテクチャのようなアーキテクチャ・アプローチでは、APIインタラクションをモデル化することの重要性は極めて重要です。APIトラフィックとコンポネント間のコミュニケーションスタイルについて学ぶことは、たくさんの疎結合化による利点を享受するか、メンテナンスの悪夢を作り出すかの違いに影響してきます。

データセンターのエンジニアは、トラフィックパターンを使ってデータセンター内や低レベルのアプリケーション間で行われるネットワーク交換を記述します。しかし、APIレベルでは、アプリケーションのグループ間のフローを記述するために、トラフィックパターンを使用します。この本の目的上、アプリケーションとAPIレベルのトラフィックパターンについて説明します。

## ケーススタディ: 進化ステップ
トラフィックパターンの種類を検討し始めるには、ケーススタディのアーキテクチャを少し進化させることが有効です。

![カンファレンスシステムのコンテキストダイアグラム4](./img/4.png)

上図では、従来のカンファレンス・システム内の出席者モジュールを、出席者コンポーネントとして独立したサービスにリファクタリングする手順が実行されています。カンファレンスシステムには「利用者とカンファレンス・システム間のインタラクション」と「カンファレンスシステムと出席者システム間のインタラクション」の2つのトラフィックフローがあります。

## 垂直型トラフィック
上図では、利用者とカンファレンス・システムの間の相互作用は垂直型トラフィックと呼ばれ、入力方向のフローを表しています。利用者はUIを使用し、インターネット経由にカンファレンス・システムにリクエストを送信します。これは、一般に公開され、UIからアクセスされるネットワーク上のポイントを表しています。つまり、North-South トラフィックを処理するコンポーネントは、クライアントの身元について具体的なチェッ クを行い、トラフィックをシステムで進行させる前に適切なチャレンジを含めなければな らない、ということである。第7章では、North-South APIトラフィックのセキュリティについて詳しく説明します。